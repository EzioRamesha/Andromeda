CREATE OR ALTER PROCEDURE [dbo].[RiDataWarehouseUpdate] (@RiDataId INT, @RiDataWarehouseId INT)

AS

UPDATE 
	RiDataWarehouse 
SET 
	[EndingPolicyStatus] = CASE WHEN rd.PolicyStatusCode = dbo.GetConstant('PolicyStatusCodeTerminated') AND (rd.RecordType != 2 OR rd.Aar != RiDataWarehouse.Aar) 
							THEN dbo.GetPickListDetailId(dbo.GetConstant('PolicyStatusCodeReversal'), 18)
							ELSE dbo.GetPickListDetailId(rd.PolicyStatusCode, 18) END,
	[Quarter] = (Select rdb.Quarter FROM RiDataBatches rdb WHERE rd.RiDataBatchId = rdb.Id),
	[TreatyCode] = rd.[TreatyCode],
	[ReinsBasisCode] = rd.[ReinsBasisCode],
	[FundsAccountingTypeCode] = rd.[FundsAccountingTypeCode],
	[PremiumFrequencyCode] = rd.[PremiumFrequencyCode],
	[ReportPeriodMonth] = rd.[ReportPeriodMonth],
	[ReportPeriodYear] = rd.[ReportPeriodYear],
	[RiskPeriodMonth] = rd.[RiskPeriodMonth],
	[RiskPeriodYear] = rd.[RiskPeriodYear],
	[TransactionTypeCode] = rd.[TransactionTypeCode],
	[PolicyNumber] = rd.[PolicyNumber],
	[IssueDatePol] = rd.[IssueDatePol],
	[IssueDateBen] = rd.[IssueDateBen],
	[ReinsEffDatePol] = rd.[ReinsEffDatePol],
	[ReinsEffDateBen] = rd.[ReinsEffDateBen],
	[CedingPlanCode] = rd.[CedingPlanCode],
	[CedingBenefitTypeCode] = rd.[CedingBenefitTypeCode],
	[CedingBenefitRiskCode] = rd.[CedingBenefitRiskCode],
	[MlreBenefitCode] = rd.[MlreBenefitCode],
	[OriSumAssured] = rd.[OriSumAssured],
	[CurrSumAssured] = rd.[CurrSumAssured],
	[AmountCededB4MlreShare] = rd.[AmountCededB4MlreShare],
	[RetentionAmount] = rd.[RetentionAmount],
	[AarOri] = rd.[AarOri],
	[Aar] = rd.[Aar],
	[AarSpecial1] = rd.[AarSpecial1],
	[AarSpecial2] = rd.[AarSpecial2],
	[AarSpecial3] = rd.[AarSpecial3],
	[InsuredName] = rd.[InsuredName],
	[InsuredGenderCode] = rd.[InsuredGenderCode],
	[InsuredTobaccoUse] = rd.[InsuredTobaccoUse],
	[InsuredDateOfBirth] = rd.[InsuredDateOfBirth],
	[InsuredOccupationCode] = rd.[InsuredOccupationCode],
	[InsuredRegisterNo] = rd.[InsuredRegisterNo],
	[InsuredAttainedAge] = rd.[InsuredAttainedAge],
	[InsuredNewIcNumber] = rd.[InsuredNewIcNumber],
	[InsuredOldIcNumber] = rd.[InsuredOldIcNumber],
	[InsuredName2nd] = rd.[InsuredName2nd],
	[InsuredGenderCode2nd] = rd.[InsuredGenderCode2nd],
	[InsuredTobaccoUse2nd] = rd.[InsuredTobaccoUse2nd],
	[InsuredDateOfBirth2nd] = rd.[InsuredDateOfBirth2nd],
	[InsuredAttainedAge2nd] = rd.[InsuredAttainedAge2nd],
	[InsuredNewIcNumber2nd] = rd.[InsuredNewIcNumber2nd],
	[InsuredOldIcNumber2nd] = rd.[InsuredOldIcNumber2nd],
	[ReinsuranceIssueAge] = rd.[ReinsuranceIssueAge],
	[ReinsuranceIssueAge2nd] = rd.[ReinsuranceIssueAge2nd],
	[PolicyTerm] = rd.[PolicyTerm],
	[PolicyExpiryDate] = rd.[PolicyExpiryDate],
	[DurationYear] = rd.[DurationYear],
	[DurationDay] = rd.[DurationDay],
	[DurationMonth] = rd.[DurationMonth],
	[PremiumCalType] = rd.[PremiumCalType],
	[CedantRiRate] = rd.[CedantRiRate],
	[RateTable] = rd.[RateTable],
	[AgeRatedUp] = rd.[AgeRatedUp],
	[DiscountRate] = rd.[DiscountRate],
	[LoadingType] = rd.[LoadingType],
	[UnderwriterRating] = rd.[UnderwriterRating],
	[UnderwriterRatingUnit] = rd.[UnderwriterRatingUnit],
	[UnderwriterRatingTerm] = rd.[UnderwriterRatingTerm],
	[UnderwriterRating2] = rd.[UnderwriterRating2],
	[UnderwriterRatingUnit2] = rd.[UnderwriterRatingUnit2],
	[UnderwriterRatingTerm2] = rd.[UnderwriterRatingTerm2],
	[UnderwriterRating3] = rd.[UnderwriterRating3],
	[UnderwriterRatingUnit3] = rd.[UnderwriterRatingUnit3],
	[UnderwriterRatingTerm3] = rd.[UnderwriterRatingTerm3],
	[FlatExtraAmount] = rd.[FlatExtraAmount],
	[FlatExtraUnit] = rd.[FlatExtraUnit],
	[FlatExtraTerm] = rd.[FlatExtraTerm],
	[FlatExtraAmount2] = rd.[FlatExtraAmount2],
	[FlatExtraTerm2] = rd.[FlatExtraTerm2],
	[StandardPremium] = rd.[StandardPremium],
	[SubstandardPremium] = rd.[SubstandardPremium],
	[FlatExtraPremium] = rd.[FlatExtraPremium],
	[GrossPremium] = rd.[GrossPremium],
	[StandardDiscount] = rd.[StandardDiscount],
	[SubstandardDiscount] = rd.[SubstandardDiscount],
	[VitalityDiscount] = rd.[VitalityDiscount],
	[TotalDiscount] = rd.[TotalDiscount],
	[NetPremium] = rd.NetPremium,
	[AnnualRiPrem] = rd.[AnnualRiPrem],
	[RiCovPeriod] = rd.[RiCovPeriod],
	[AdjBeginDate] = rd.[AdjBeginDate],
	[AdjEndDate] = rd.[AdjEndDate],
	[PolicyNumberOld] = rd.[PolicyNumberOld],
	[PolicyStatusCode] = rd.[PolicyStatusCode],
	[PolicyGrossPremium] = rd.[PolicyGrossPremium],
	[PolicyStandardPremium] = rd.[PolicyStandardPremium],
	[PolicySubstandardPremium] = rd.[PolicySubstandardPremium],
	[PolicyTermRemain] = rd.[PolicyTermRemain],
	[PolicyAmountDeath] = rd.[PolicyAmountDeath],
	[PolicyReserve] = rd.[PolicyReserve],
	[PolicyPaymentMethod] = rd.[PolicyPaymentMethod],
	[PolicyLifeNumber] = rd.[PolicyLifeNumber],
	[FundCode] = rd.[FundCode],
	[LineOfBusiness] = rd.[LineOfBusiness],
	[ApLoading] = rd.[ApLoading],
	[LoanInterestRate] = rd.[LoanInterestRate],
	[DefermentPeriod] = rd.[DefermentPeriod],
	[RiderNumber] = rd.[RiderNumber],
	[CampaignCode] = rd.[CampaignCode],
	[Nationality] = rd.[Nationality],
	[TerritoryOfIssueCode] = rd.[TerritoryOfIssueCode],
	[CurrencyCode] = rd.[CurrencyCode],
	[StaffPlanIndicator] = rd.[StaffPlanIndicator],
	[CedingTreatyCode] = rd.[CedingTreatyCode],
	[CedingPlanCodeOld] = rd.[CedingPlanCodeOld],
	[CedingBasicPlanCode] = rd.[CedingBasicPlanCode],
	[CedantSar] = rd.[CedantSar],
	[CedantReinsurerCode] = rd.[CedantReinsurerCode],
	[AmountCededB4MlreShare2] = rd.[AmountCededB4MlreShare2],
	[CessionCode] = rd.[CessionCode],
	[CedantRemark] = rd.[CedantRemark],
	[GroupPolicyNumber] = rd.[GroupPolicyNumber],
	[GroupPolicyName] = rd.[GroupPolicyName],
	[NoOfEmployee] = rd.[NoOfEmployee],
	[PolicyTotalLive] = rd.[PolicyTotalLive],
	[GroupSubsidiaryName] = rd.[GroupSubsidiaryName],
	[GroupSubsidiaryNo] = rd.[GroupSubsidiaryNo],
	[GroupEmployeeBasicSalary] = rd.[GroupEmployeeBasicSalary],
	[GroupEmployeeJobType] = rd.[GroupEmployeeJobType],
	[GroupEmployeeJobCode] = rd.[GroupEmployeeJobCode],
	[GroupEmployeeBasicSalaryRevise] = rd.[GroupEmployeeBasicSalaryRevise],
	[GroupEmployeeBasicSalaryMultiplier] = rd.[GroupEmployeeBasicSalaryMultiplier],
	[CedingPlanCode2] = rd.[CedingPlanCode2],
	[DependantIndicator] = rd.[DependantIndicator],
	[GhsRoomBoard] = rd.[GhsRoomBoard],
	[PolicyAmountSubstandard] = rd.[PolicyAmountSubstandard],
	[Layer1RiShare] = rd.[Layer1RiShare],
	[Layer1InsuredAttainedAge] = rd.[Layer1InsuredAttainedAge],
	[Layer1InsuredAttainedAge2nd] = rd.[Layer1InsuredAttainedAge2nd],
	[Layer1StandardPremium] = rd.[Layer1StandardPremium],
	[Layer1SubstandardPremium] = rd.[Layer1SubstandardPremium],
	[Layer1GrossPremium] = rd.[Layer1GrossPremium],
	[Layer1StandardDiscount] = rd.[Layer1StandardDiscount],
	[Layer1SubstandardDiscount] = rd.[Layer1SubstandardDiscount],
	[Layer1TotalDiscount] = rd.[Layer1TotalDiscount],
	[Layer1NetPremium] = rd.[Layer1NetPremium],
	[Layer1GrossPremiumAlt] = rd.[Layer1GrossPremiumAlt],
	[Layer1TotalDiscountAlt] = rd.[Layer1TotalDiscountAlt],
	[Layer1NetPremiumAlt] = rd.[Layer1NetPremiumAlt],
	[SpecialIndicator1] = rd.[SpecialIndicator1],
	[SpecialIndicator2] = rd.[SpecialIndicator2],
	[SpecialIndicator3] = rd.[SpecialIndicator3],
	[IndicatorJointLife] = rd.[IndicatorJointLife],
	[TaxAmount] = rd.[TaxAmount],
	[GstIndicator] = rd.[GstIndicator],
	[GstGrossPremium] = rd.[GstGrossPremium],
	[GstTotalDiscount] = rd.[GstTotalDiscount],
	[GstVitality] = rd.[GstVitality],
	[GstAmount] = rd.[GstAmount],
	[Mfrs17BasicRider] = rd.[Mfrs17BasicRider],
	[Mfrs17CellName] = rd.[Mfrs17CellName],
	[Mfrs17TreatyCode] = rd.[Mfrs17TreatyCode],
	[LoaCode] = rd.[LoaCode],
	[CurrencyRate] = rd.[CurrencyRate],
	[NoClaimBonus] = rd.[NoClaimBonus],
	[SurrenderValue] = rd.[SurrenderValue],
	[DatabaseCommision] = rd.[DatabaseCommision],
	[GrossPremiumAlt] = rd.[GrossPremiumAlt],
	[NetPremiumAlt] = rd.[NetPremiumAlt],
	[Layer1FlatExtraPremium] = rd.[Layer1FlatExtraPremium],
	[TransactionPremium] = rd.[TransactionPremium],
	[OriginalPremium] = rd.[OriginalPremium],
	[TransactionDiscount] = rd.[TransactionDiscount],
	[OriginalDiscount] = rd.[OriginalDiscount],
	[BrokerageFee] = rd.[BrokerageFee],
	[MaxUwRating] = rd.[MaxUwRating],
	[RetentionCap] = rd.[RetentionCap],
	[AarCap] = rd.[AarCap],
	[RiRate] = rd.[RiRate],
	[RiRate2] = rd.[RiRate2],
	[AnnuityFactor] = rd.[AnnuityFactor],
	[SumAssuredOffered] = rd.[SumAssuredOffered],
	[UwRatingOffered] = rd.[UwRatingOffered],
	[FlatExtraAmountOffered] = rd.[FlatExtraAmountOffered],
	[FlatExtraDuration] = rd.[FlatExtraDuration],
	[EffectiveDate] = rd.[EffectiveDate],
	[OfferLetterSentDate] = rd.[OfferLetterSentDate],
	[RiskPeriodStartDate] = rd.[RiskPeriodStartDate],
	[RiskPeriodEndDate] = rd.[RiskPeriodEndDate],
	[Mfrs17AnnualCohort] = rd.[Mfrs17AnnualCohort],
	[MaxExpiryAge] = rd.[MaxExpiryAge],
	[MinIssueAge] = rd.[MinIssueAge],
	[MaxIssueAge] = rd.[MaxIssueAge],
	[MinAar] = rd.[MinAar],
	[MaxAar] = rd.[MaxAar],
	[CorridorLimit] = rd.[CorridorLimit],
	[Abl] = rd.[Abl],
	[RatePerBasisUnit] = rd.[RatePerBasisUnit],
	[RiDiscountRate] = rd.[RiDiscountRate],
	[LargeSaDiscount] = rd.[LargeSaDiscount],
	[GroupSizeDiscount] = rd.[GroupSizeDiscount],
	[EwarpNumber] = rd.[EwarpNumber],
	[EwarpActionCode] = rd.[EwarpActionCode],
	[RetentionShare] = rd.[RetentionShare],
	[AarShare] = rd.[AarShare],
	[ProfitComm] = rd.[ProfitComm],
	[TotalDirectRetroAar] = rd.[TotalDirectRetroAar],
	[TotalDirectRetroGrossPremium] = rd.[TotalDirectRetroGrossPremium],
	[TotalDirectRetroDiscount] = rd.[TotalDirectRetroDiscount],
	[TotalDirectRetroNetPremium] = rd.[TotalDirectRetroNetPremium],
	[TreatyType] = rd.[TreatyType],
	[LastUpdatedDate] = Convert(date, GETDATE()),
	[UpdatedAt] = GETDATE(),
	[UpdatedById] = 1,
	[RetroParty1] = rd.[RetroParty1],
	[RetroParty2] = rd.[RetroParty2],
	[RetroParty3] = rd.[RetroParty3],
	[RetroShare1] = rd.[RetroShare1],
	[RetroShare2] = rd.[RetroShare2],
	[RetroShare3] = rd.[RetroShare3],
	[RetroAar1] = rd.[RetroAar1],
	[RetroAar2] = rd.[RetroAar2],
	[RetroAar3] = rd.[RetroAar3],
	[RetroReinsurancePremium1] = rd.[RetroReinsurancePremium1],
	[RetroReinsurancePremium2] = rd.[RetroReinsurancePremium2],
	[RetroReinsurancePremium3] = rd.[RetroReinsurancePremium3],
	[RetroDiscount1] = rd.[RetroDiscount1],
	[RetroDiscount2] = rd.[RetroDiscount2],
	[RetroDiscount3] = rd.[RetroDiscount3],
	[RetroNetPremium1] = rd.[RetroNetPremium1],
	[RetroNetPremium2] = rd.[RetroNetPremium2],
	[RetroNetPremium3] = rd.[RetroNetPremium3],
	[AarShare2] =  rd.[AarShare2],
	[AarCap2] =  rd.[AarCap2],
	[WakalahFeePercentage] =  rd.[WakalahFeePercentage],
	[MaxApLoading] =  rd.[MaxApLoading],
	[MlreInsuredAttainedAgeAtCurrentMonth] = RD.[MlreInsuredAttainedAgeAtCurrentMonth],
	[MlreInsuredAttainedAgeAtPreviousMonth] =  rd.[MlreInsuredAttainedAgeAtPreviousMonth],
	[MlrePolicyIssueAge] = rd.[MlrePolicyIssueAge],
	[MlreStandardPremium] = rd.[MlreStandardPremium],
	[MlreSubstandardPremium] = rd.[MlreSubstandardPremium],
	[MlreFlatExtraPremium] = rd.[MlreFlatExtraPremium],
	[MlreGrossPremium] = rd.[MlreGrossPremium],
	[MlreStandardDiscount] =  rd.[MlreStandardDiscount],
	[MlreSubstandardDiscount] =  rd.[MlreSubstandardDiscount],
	[MlreLargeSaDiscount] =  rd.[MlreLargeSaDiscount],
	[MlreGroupSizeDiscount] =  rd.[MlreGroupSizeDiscount],
	[MlreVitalityDiscount] =  rd.[MlreVitalityDiscount],
	[MlreTotalDiscount] = rd.[MlreTotalDiscount],
	[MlreNetPremium] = rd.[MlreNetPremium],
	[NetPremiumCheck] = rd.[NetPremiumCheck],
	[ServiceFee] =  rd.[ServiceFee],
	[MlreBrokerageFee] =  rd.[MlreBrokerageFee],
	[MlreDatabaseCommission] =  rd.[MlreDatabaseCommission],
	[TreatyNumber] =  rd.[TreatyNumber],
	[TotalDirectRetroNoClaimBonus] =  rd.[TotalDirectRetroNoClaimBonus],
	[TotalDirectRetroDatabaseCommission] =  rd.[TotalDirectRetroDatabaseCommission],
	[RetroPremiumSpread1] =  rd.[RetroPremiumSpread1],
	[RetroPremiumSpread2] =  rd.[RetroPremiumSpread2],
	[RetroPremiumSpread3] =  rd.[RetroPremiumSpread3],
	[RetroNoClaimBonus1] =  rd.[RetroNoClaimBonus1],
	[RetroNoClaimBonus2] =  rd.[RetroNoClaimBonus2],
	[RetroNoClaimBonus3] =  rd.[RetroNoClaimBonus3],
	[RetroDatabaseCommission1] =  rd.[RetroDatabaseCommission1],
	[RetroDatabaseCommission2] =  rd.[RetroDatabaseCommission2],
	[RetroDatabaseCommission3] =  rd.[RetroDatabaseCommission3],
	[InsuredAttainedAgeCheck] = rd.[InsuredAttainedAgeCheck],
	[MaxExpiryAgeCheck] = rd.[MaxExpiryAgeCheck],
	[PolicyIssueAgeCheck] = rd.[PolicyIssueAgeCheck],
	[MinIssueAgeCheck] = rd.[MinIssueAgeCheck],
	[MaxIssueAgeCheck] = rd.[MaxIssueAgeCheck],
	[MaxUwRatingCheck] = rd.[MaxUwRatingCheck],
	[ApLoadingCheck] = rd.[ApLoadingCheck],
	[EffectiveDateCheck] = rd.[EffectiveDateCheck],
	[MinAarCheck] = rd.[MinAarCheck],
	[MaxAarCheck] = rd.[MaxAarCheck],
	[CorridorLimitCheck] = rd.[CorridorLimitCheck],
	[AblCheck] = rd.[AblCheck],
	[RetentionCheck] = rd.[RetentionCheck],
	[AarCheck] = rd.[AarCheck],
	[ValidityDayCheck] = rd.[ValidityDayCheck],
	[SumAssuredOfferedCheck] = rd.[SumAssuredOfferedCheck],
	[UwRatingCheck] = rd.[UwRatingCheck],
	[FlatExtraAmountCheck] = rd.[FlatExtraAmountCheck],
	[FlatExtraDurationCheck] = rd.[FlatExtraDurationCheck],
	[ConflictType] = rd.[ConflictType],
	[RecordType] = rd.[RecordType]
FROM 
	(SELECT * FROM RiData WHERE Id = @RiDataId) AS rd
WHERE 
  RiDataWarehouse.Id = @RiDataWarehouseId
